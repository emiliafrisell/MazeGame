<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>MazeGame</title>
    <meta name="description" content="MazeGame - Fun Trivia Maze Game built on A-frame & Three.js">

    <!-- <script src="https://unpkg.com/aframe@latest"></script> -->

    <!--Libraries & external scripts Import-->
     <script src="libs/aframe.js"></script> <!--   Aframe.js(v0.3.0) Library -->
    <script src="libs/aframe-extras.js"></script>    <!--Aframe-extras.js(v2.6.1) Library-->
    <script src="libs/aframe-text-component.min.js"></script>   <!--Aframe library used for rendering text-->
    <script src="libs/lz-string.min.js"></script>   <!--LZ-based compression algorithm for JavaScript-->
    <script src="libs/aframe-bmfont-text-component.js"></script>    <!--Aframe library used for rendering bitmap font text-->
    <script src="src/game.js"></script>
    <script src="src/common.js"></script>    <!--JavaScript for the maze-->
    <script src="https://cdn.jsdelivr.net/npm/aframe-glow@1.0.1/dist/aframe-glow-component.js"></script>


    <!-- ENABLE ANIMATION -->
    <script src="https://unpkg.com/aframe-extras@6.1.0/dist/aframe-extras.loaders.min.js"></script>

  </head>

  <body>

    <!--Anchored VR Design-->
    <!--Aframe scene starts here-->
    <!-- fog="type: linear; color: #AAB; near: 0; far:10;"  -->
    <a-scene physics id="scene" fog="type: linear; color: #AAB; near: 0; far:10;">
      <!-- <a-sky color="#007FF0"></a-sky> -->

      <!--Importing Assets-->
      <!--Diegetic UI Elements-->
      <a-assets>
        <img src="assets/door.png" id="door">
        <img src="assets/corn.jpg" id="asset_wall">
        <img src="assets/blue-sky.png" id="asset_roof">
        <img src="assets/path.jpeg" id="asset_ground">
        <!-- <img src="assets/instruction.jpg" id="asset_instruction"> -->
        <img src="assets/reload.png" id="asset_reload">
        <a-asset-item src="assets/tree.glb" id="asset_character"></a-asset-item>
      </a-assets>
      <!--Entity to add background noise-->
      <a-entity sound="src: url(assets/audio/backgroundnoise.mp3); autoplay: true; loop:true; distanceModel:linear">
      </a-entity>
      <a-gltf-model
      src="assets/scene.glb"
      position="-25 1 -19"
      animation-mixer="clip: *;"
      scale="0.01 0.01 0.01"
      shadow
      static-body
    ></a-gltf-model>

      <!--Camera/Player body Entity-->
      <a-entity static-body
                sound="src: url(assets/audio/bat.mp3); on: collide; volume:0.01;"  
                velocity="0 0 0" 
                rotation="0 0 0" 
                position="0 1.6 -2" 
                id="camera" 
                camera="" 
                kinematic-body 
                universal-controls>
                <!--Entity to create a crosshair-->
                <!--Crosshair is a Non-Diegetic UI Element-->
                <a-entity cursor="fuse: true; fuseTimeout: 500"
                  position="0 0 -1"
                  geometry="primitive: ring; radiusInner: 0.02; radiusOuter: 0.03"
                  material="color:#20639B; shader: flat">
                </a-entity>
                <!--Entity for Timer-->
                <!--Timer is a Non-Diegetic UI Element-->
                <a-entity text="text: Time;size:.07;height:0.001" material="color:red" position="1 0.65 -1" id="board"></a-entity>

                <!-- What you've found so far  -->
                <a-entity text="text: Found;size:.07;height:0.001" material="color:red" position="-1 0.65 -1" id="found"></a-entity>

                <!--Entity for Winner text-->
                <a-entity text="text: ;size:0.1;height:0.001" material="color:#f4ff61" position="-0.6 0 -1" id="winner"></a-entity>
                <a-entity text="text: ;size:0.1;height:0.001" material="color:#f4ff61" position="-0.6 0 -1" id="red"></a-entity>
      </a-entity>               
              
    </a-scene>
    <!--Aframe scene ends here-->

    <!--JavaScript Starts here-->
    
    <script>
      //  Reload Game Component
      AFRAME.registerComponent('on-click', {
        init: function () {
          this.el.addEventListener('click', function (evt) {
            location.reload();
          });
        }
      });

      // Instructions Glow Component
      AFRAME.registerComponent('on-gaze', {
      init: function () {
        this.el.addEventListener('mouseenter', function (evt) {
        // var glow = document.getElementById("character");
        // glow.setAttribute('glow','side: front; scale: 2; color: #e8cd00; c: 0.1; p: 3.5;');
      });
      this.el.addEventListener('mouseleave', function (evt) {
        // var glow = document.getElementById("character");
        // glow.setAttribute('glow','enabled:false');
      });
      }
      });


      /* Maze formation */
      
      var maze;

      // Player body collision Text display
      var cam = document.getElementById('camera');
      let found = [];

      const addBoxToFound = (color) => {
        if (document.getElementById(color) !== null) {
          found.push(color)
          document.getElementById(color).setAttribute('position', '0 -1 0');
          console.log(color)
        }
      }

      cam.addEventListener('collide', function (e) {
        let id = e.detail.body.el.getAttribute('id')
        
        if (id == 'character') {
          
          console.log('hit the box')
          
          var red = document.getElementById('red');
          var attr_text = red.getAttribute('text');
          attr_text.text = "You Found the box!";
          red.setAttribute('text', attr_text);
          
          setTimeout(() => {  
            attr_text.text = "";
            red.setAttribute('text', attr_text);
          }, 1500)

          document.getElementById('character').setAttribute('visible', 'false')
          document.getElementById('character').setAttribute('position', '0 -1 0');
          
        }

        // if (e 

        if (id !== 'null' && id !== 'price') {
          addBoxToFound(id)
        }

        // if (e.detail.body.el.getAttribute('id') == 'yellow') {
        //   found.push(e.detail.body.el.getAttribute('id'))
        //   document.getElementById('yellow').setAttribute('position', '0 -1 0');

        // }

        // if (e.detail.body.el.getAttribute('id') == 'blue') {
        //   found.push(e.detail.body.el.getAttribute('id'))
        //   document.getElementById('blue').setAttribute('position', '0 -1 0');

        // }
        
        // if (e.detail.body.el.getAttribute('id') == 'green') {
        //   found.push(e.detail.body.el.getAttribute('id'))
        //   document.getElementById('green').setAttribute('position', '0 -1 0');
        // }

        // if (e.detail.body.el.getAttribute('id') == 'orange') {
        //   console.log('found orange')
        //   found.push(e.detail.body.el.getAttribute('id'))
        //   document.getElementById('orange').setAttribute('position', '0 -1 0');

        // }

        // if (e.detail.body.el.getAttribute('id') == 'purple') {
        //   found.push(e.detail.body.el.getAttribute('id'))
        //   document.getElementById('purple').setAttribute('position', '0 -1 0');
        // }

          // Found Items 

          var progress = document.getElementById('found');
            var attr_text = progress.getAttribute('text');
            // console.log(attr_text)
            attr_text.text = 'You\'ve found: ' + found;
            var prog = attr_text;
            progress.setAttribute('text', attr_text);

          // console.log(found)

        if (e.detail.body.el.getAttribute('id') == 'price') {
          var winner = document.getElementById('winner');
          var attr_text = winner.getAttribute('text');

          if(found.length < 2) {
            attr_text.text = 'find more';
            winner.setAttribute('text', attr_text);

            setTimeout(() => {  
              attr_text.text = "";
              winner.setAttribute('text', attr_text);
            }, 1500)

          } else {
            clearInterval(counter);
            
            attr_text.text = found;
            winner.setAttribute('text', attr_text);

          }
        }
        
        // console.log(cam.getAttribute('position'))

      });


      var seconds = 0;
      var counter;
      
      // Creating a maze array
      function init(width,height) {

        clearInterval(counter);
        maze = new Array(parseInt(height));

        for (var i = 0; i < maze.length; i++) {
          maze[i] = [].repeat(0, width);
          // console.log(i+':',maze[i])
        }


        // Randomized path generation 
        buildPath(maze,[0,0]);

        if(typeof QueryString.maze == 'undefined'){
          window.location.hash += '&maze='+LZString.compressToBase64(JSON.stringify(maze));
        }else{
          maze = JSON.parse(LZString.decompressFromBase64(QueryString.maze))
        }
        paintMaze(maze);

        // Timer Function

        seconds = 0;
        counter = setInterval(function(){
          var board = document.getElementById('board');
          var attr_text = board.getAttribute('text');
          attr_text.text = seconds++;
          var sec = attr_text;
          board.setAttribute('text',attr_text);
        },1000);
      }

      // Maze Width & Height
      
      var width = QueryString.width;
      var height = QueryString.height;
      if(typeof width == 'undefined'){
        width = 18;
      }
      if(typeof height == 'undefined'){
        height = 14;
      }
      init(width,height);


    </script>

   <!--JavaScript ends here-->
  </body>
</html>
